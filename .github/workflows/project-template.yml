# ============================================================================
# Reusable template: Rename/Remove, Snapshot, Push to Base Branch
# Called via: jobs.<name>.uses: ./.github/workflows/project-template.yml
# ============================================================================

name: Project Template

on:
  workflow_call:
    inputs:
      app_name:
        description: "New application name to pass to the Rename tool"
        required: true
        type: string
      selections:
        description: "Argument for the Remove Modules tool (e.g., keep:Tags or remove:all)"
        required: true
        type: string
      base_branch:
        description: "Target base branch to push sanitized snapshot to (empty to skip)"
        required: true
        type: string

permissions:
  contents: write

env:
  REMOVE_EXE: '.\Remove Modules from FreeCRM.exe'
  RENAME_EXE: '.\Rename FreeCRM.exe'
  DOTNET_VERSION: 9.0.x

defaults:
  run:
    shell: pwsh

jobs:
  project:
    name: Project — ${{ inputs.app_name }} (${{
      (inputs.base_branch != '' && format('→ {0}', inputs.base_branch)) || 'no push'
    }})
    runs-on: windows-latest

    steps:
      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          ref: main
          path: _main
          fetch-depth: 0

      - name: Checkout base branch (if provided)
        if: ${{ inputs.base_branch != '' }}
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.base_branch }}
          path: _base
          fetch-depth: 0

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Run remove modules
        run: |
          cd _main
          if (!(Test-Path "${{ env.REMOVE_EXE }}")) { throw "Remove tool not found: ${{ env.REMOVE_EXE }}" }
          & "${{ env.REMOVE_EXE }}" "${{ inputs.selections }}"

      - name: Run rename (allow numbers/underscores)
        run: |
          cd _main
          if (!(Test-Path "${{ env.RENAME_EXE }}")) { throw "Rename tool not found: ${{ env.RENAME_EXE }}" }
          & "${{ env.RENAME_EXE }}" "${{ inputs.app_name }}"

      - name: Snapshot source after rename/remove (sanitized for push)
        run: |
          $src = Join-Path $pwd "_main"
          $dst = Join-Path $pwd "artifacts\source_after_changes_$("${{ inputs.app_name }}")"
          $zip = Join-Path $env:RUNNER_TEMP "snapshot_$("${{ inputs.app_name }}").zip"
          New-Item -ItemType Directory -Force -Path $dst | Out-Null
          Remove-Item -Recurse -Force "$src\.github","$src\artifacts" -ErrorAction SilentlyContinue
          Compress-Archive -Path "$src\*" -DestinationPath $zip -Force
          Expand-Archive -Path $zip -DestinationPath $dst -Force
          "SNAPSHOT_PATH=$zip" | Out-File -FilePath $env:GITHUB_ENV -Append

      - name: Upload source snapshot (post-rename)
        uses: actions/upload-artifact@v4
        with:
          name: source_after_changes_${{ inputs.app_name }}
          path: artifacts/source_after_changes_${{ inputs.app_name }}

      - name: Push to base branch
        if: ${{ inputs.base_branch != '' }}
        run: |
          cd _base
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          Get-ChildItem -Force | Where-Object { $_.Name -ne ".git" } | Remove-Item -Recurse -Force
          Copy-Item -Path "$env:GITHUB_WORKSPACE\artifacts\source_after_changes_$("${{ inputs.app_name }}")\*" -Destination . -Recurse -Force
          git add -A
          $commitMsg = git -C ..\_main log -1 --pretty=%B origin/main
          git commit -m "Regenerated ${{ inputs.base_branch }}: $commitMsg" || echo "No changes to commit"
          git push origin HEAD:${{ inputs.base_branch }} --force
