name: Rename • Build/Test • (Optional) Branch Push

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

permissions:
  contents: write

env:
  REMOVE_EXE: '.\Remove Modules from FreeCRM.exe'
  RENAME_EXE: '.\Rename FreeCRM.exe'
  DOTNET_VERSION: 9.0.x

jobs:
  project-freecicd:
    name: 1. FreeCICD
    uses: WSU-EIT/FreeCRM/.github/workflows/project-template.yml@main
    with:
      app_name: "FreeCICD"
      selections: "keep:Tags"
      base_branch: "FreeCICD_base"
    secrets: inherit

  project-freellm:
    name: 1. FreeLLM
    uses: WSU-EIT/FreeCRM/.github/workflows/project-template.yml@main
    with:
      app_name: "FreeLLM"
      selections: "remove:all"
      base_branch: "FreeLLM_base"
    secrets: inherit

  project-freemanager:
    name: 1. FreeManager
    uses: WSU-EIT/FreeCRM/.github/workflows/project-template.yml@main
    with:
      app_name: "FreeManager"
      selections: "remove:all"
      base_branch: "FreeManager_base"
    secrets: inherit

  project-pjprocessor:
    name: 1. PJProcessor
    uses: WSU-EIT/FreeCRM/.github/workflows/project-template.yml@main
    with:
      app_name: "PJProcessor"
      selections: "remove:all"
      base_branch: "PJProcessor_base"
    secrets: inherit

  project-touchpoints:
    name: 1. Touchpoints
    uses: WSU-EIT/FreeCRM/.github/workflows/project-template.yml@main
    with:
      app_name: "Touchpoints"
      selections: "remove:all"
      base_branch: "Touchpoints_base"
    secrets: inherit

  project-freeai:
    name: 1. FreeAI
    uses: WSU-EIT/FreeCRM/.github/workflows/project-template.yml@main
    with:
      app_name: "FreeAI"
      selections: "remove:all"
      base_branch: "FreeAI_base"
    secrets: inherit

  build-test-singles:
    name: 2. Singles — Build/Test
    needs: 
      - project-freecicd
      - project-freellm
      - project-freemanager
      - project-pjprocessor
      - project-touchpoints
      - project-freeai
    uses: WSU-EIT/FreeCRM/.github/workflows/build-test-template.yml@main
    with:
      job_title_prefix: "2. "
      matrix_json: >
        {"test":[
          {"id":"T01","selections":"keep:Appointments"},
          {"id":"T02","selections":"remove:Appointments"},
          {"id":"T03","selections":"keep:EmailTemplates"},
          {"id":"T04","selections":"remove:EmailTemplates"},
          {"id":"T05","selections":"keep:Invoices"},
          {"id":"T06","selections":"remove:Invoices"},
          {"id":"T07","selections":"keep:Locations"},
          {"id":"T08","selections":"remove:Locations"},
          {"id":"T09","selections":"keep:Payments"},
          {"id":"T10","selections":"remove:Payments"},
          {"id":"T11","selections":"keep:Services"},
          {"id":"T12","selections":"remove:Services"},
          {"id":"T13","selections":"keep:Tags"},
          {"id":"T14","selections":"remove:Tags"}
        ]}
    secrets: inherit

  generate-combos:
    name: 2a. Generate matrices for k=2..7
    runs-on: ubuntu-latest
    needs: build-test-singles
    outputs:
      matrix2: ${{ steps.make.outputs.matrix2 }}
      matrix3: ${{ steps.make.outputs.matrix3 }}
      matrix4: ${{ steps.make.outputs.matrix4 }}
      matrix5: ${{ steps.make.outputs.matrix5 }}
      matrix6: ${{ steps.make.outputs.matrix6 }}
      matrix7: ${{ steps.make.outputs.matrix7 }}
      count2:  ${{ steps.make.outputs.count2 }}
      count3:  ${{ steps.make.outputs.count3 }}
      count4:  ${{ steps.make.outputs.count4 }}
      count5:  ${{ steps.make.outputs.count5 }}
      count6:  ${{ steps.make.outputs.count6 }}
      count7:  ${{ steps.make.outputs.count7 }}
    steps:
      - name: Build matrices JSON
        id: make
        uses: actions/github-script@v7
        with:
          script: |
            const modules = ["Appointments","EmailTemplates","Invoices","Locations","Payments","Services","Tags"];
            function combos(arr, k, start=0, path=[], out=[]) {
              if (path.length === k) { out.push([...path]); return out; }
              for (let i = start; i <= arr.length - (k - path.length); i++) {
                path.push(arr[i]); combos(arr, k, i+1, path, out); path.pop();
              }
              return out;
            }
            function matrixForK(k) {
              const test=[]; const cks=combos(modules,k);
              cks.forEach((c, i) => {
                const list=c.join(",");
                const id=`K${k}-${String(i+1).padStart(2,"0")}`;
                test.push({id:`${id}-K`,selections:`keep:${list}`});
                test.push({id:`${id}-R`,selections:`remove:${list}`});
              });
              return { test };
            }
            const m2=matrixForK(2), m3=matrixForK(3), m4=matrixForK(4), m5=matrixForK(5), m6=matrixForK(6), m7=matrixForK(7);
            core.setOutput('matrix2', JSON.stringify(m2));
            core.setOutput('matrix3', JSON.stringify(m3));
            core.setOutput('matrix4', JSON.stringify(m4));
            core.setOutput('matrix5', JSON.stringify(m5));
            core.setOutput('matrix6', JSON.stringify(m6));
            core.setOutput('matrix7', JSON.stringify(m7));
            core.setOutput('count2', String(m2.test.length));
            core.setOutput('count3', String(m3.test.length));
            core.setOutput('count4', String(m4.test.length));
            core.setOutput('count5', String(m5.test.length));
            core.setOutput('count6', String(m6.test.length));
            core.setOutput('count7', String(m7.test.length));

  build-test-2:
    name: 2b. Pairs
    needs: 
      - project-freecicd
      - project-freellm
      - project-freemanager
      - project-pjprocessor
      - project-touchpoints
      - project-freeai
      - generate-combos
    uses: WSU-EIT/FreeCRM/.github/workflows/build-test-template.yml@main
    with:
      job_title_prefix: "2b. Pairs (${{ needs.generate-combos.outputs.count2 }}) — "
      matrix_json: ${{ needs.generate-combos.outputs.matrix2 }}
    secrets: inherit

  build-test-3:
    name: 2c. Triples
    needs: [build-test-2, generate-combos]
    uses: WSU-EIT/FreeCRM/.github/workflows/build-test-template.yml@main
    with:
      job_title_prefix: "2c. Triples (${{ needs.generate-combos.outputs.count3 }}) — "
      matrix_json: ${{ needs.generate-combos.outputs.matrix3 }}
    secrets: inherit

  build-test-4:
    name: 2d. Quads
    needs: [build-test-3, generate-combos]
    uses: WSU-EIT/FreeCRM/.github/workflows/build-test-template.yml@main
    with:
      job_title_prefix: "2d. Quads (${{ needs.generate-combos.outputs.count4 }}) — "
      matrix_json: ${{ needs.generate-combos.outputs.matrix4 }}
    secrets: inherit

  build-test-5:
    name: 2e. Quintets
    needs: [build-test-4, generate-combos]
    uses: WSU-EIT/FreeCRM/.github/workflows/build-test-template.yml@main
    with:
      job_title_prefix: "2e. Quintets (${{ needs.generate-combos.outputs.count5 }}) — "
      matrix_json: ${{ needs.generate-combos.outputs.matrix5 }}
    secrets: inherit

  build-test-6:
    name: 2f. Sextets
    needs: [build-test-5, generate-combos]
    uses: WSU-EIT/FreeCRM/.github/workflows/build-test-template.yml@main
    with:
      job_title_prefix: "2f. Sextets (${{ needs.generate-combos.outputs.count6 }}) — "
      matrix_json: ${{ needs.generate-combos.outputs.matrix6 }}
    secrets: inherit

  build-test-7:
    name: 2g. Septets
    needs: [build-test-6, generate-combos]
    uses: WSU-EIT/FreeCRM/.github/workflows/build-test-template.yml@main
    with:
      job_title_prefix: "2g. Septets (${{ needs.generate-combos.outputs.count7 }}) — "
      matrix_json: ${{ needs.generate-combos.outputs.matrix7 }}
    secrets: inherit
