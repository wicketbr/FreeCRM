@page "/"
@page "/{TenantCode}"
@inject BlazorDataModel Model
@implements IDisposable

@if (Model.Loaded && Model.View == _pageName && (Model.LoggedIn || !AppModule.RequireLogin)) {
    if (Helpers.HaveBlazorToolbarButtons(_pageName)) {
        <div class="btn-group mb-2" role="group">
            <BlazorPlugins Module="@_pageName" Button="true" TValue="System.String" />
        </div>
    }

    if (Helpers.HaveBlazorPlugins(_pageName, "Top")) {
        <div class="mb-2">
            <BlazorPlugins Module="@_pageName" Position="Top" TValue="System.String" />
        </div>
    }

    <Index_App  />

    @if (AppModule.ShowTestPageLinks) {
        <h2>Test Pages</h2>

        <div class="mb-2">
            <ul>
                <li><a href="@Helpers.BuildUrl("DoubleClick")">Double-Click</a></li>
                <li><a href="@Helpers.BuildUrl("DynamicComponent")">Dynamic Blazor Components</a></li>
                <li><a href="@Helpers.BuildUrl("Monaco")">Monaco Code Editor</a></li>
                <li><a href="@Helpers.BuildUrl("Plugins")">Plugin Testing</a></li>
                <li><a href="@Helpers.BuildUrl("SortTest")">SortableList</a></li>
                <li><a href="@Helpers.BuildUrl("TimerTest")">Timer Test</a></li>
            </ul>
        </div>
    }

    if (Helpers.HaveBlazorPlugins(_pageName, "Bottom")) {
        <div class="mb-2">
            <BlazorPlugins Module="@_pageName" Position="Bottom" TValue="System.String" />
        </div>
    }
}

@code {
    [Parameter] public string? TenantCode { get; set; }

    protected bool _loadedData = false;
    protected string _pageName = "home";

    protected Index_App AppModule = new Index_App();

    public void Dispose()
    {
        Model.OnChange -= OnDataModelUpdated;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender) {
            Model.TenantCodeFromUrl = TenantCode;
        }

        if (Model.Loaded) {
            if (Model.LoggedIn || !AppModule.RequireLogin) {
                if (!_loadedData) {
                    _loadedData = true;
                    await Helpers.ValidateUrl(TenantCode, true);
                }
            } else {
                Helpers.NavigateToLogin();
            }
        }
    }

    protected void OnDataModelUpdated() {
        if (Model.View == _pageName) {
            StateHasChanged();
        }
    }

    protected override void OnInitialized()
    {
        Model.View = _pageName;
        Model.OnChange += StateHasChanged;
    }
}
